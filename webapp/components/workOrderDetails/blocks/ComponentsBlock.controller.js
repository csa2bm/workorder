sap.ui.define([	"com/twobm/mobileworkorder/util/Controller"], function(Controller) {	"use strict";	return Controller.extend("com.twobm.mobileworkorder.components.workOrderDetails.blocks.ComponentsBlock", {		onInit: function() {			this.createMaterialSelectionPopover();		},		createMaterialSelectionPopover: function() {			if (!this._oPopover) {				this._oPopover = sap.ui.xmlfragment("ComponentMaterialSelectPopUp",					"com.twobm.mobileworkorder.components.workOrderDetails.fragments.AddComponentView", this);				this._oPopover.setModel(this.getView().getModel());				this._oPopover.attachBeforeClose(function() {					// If we started creating a new entry..					if (this.getView().getModel("ComponentDetailsModel") && this.getView().getModel("ComponentDetailsModel").getData().IsCreate &&						this.newEntry) {						// ..make sure it is removed from the model if the user cancels						this.getView().getModel().deleteCreatedEntry(this.newEntry);						this.newEntry = null;					} else {						if (this.newEntry)							this.getView().getModel().resetChanges([this.newEntry.getPath()]);					}					// Make sure that the dialog starts in the initial screen					this.onNavBackToTop();				}.bind(this));				this.getView().addDependent(this._oPopover);			}		},		addMaterial: function(oEvent) {			this._oPopover.bindElement(this.getView().getBindingContext().getPath());			// Check if there is only one object - in that case show the BOM directly instead of objet selection page			this.getView().getModel().read(this.getView().getBindingContext().getPath() + "/OrderObject", {				success: function(result) {					if (result.results.length == 1)					{						var oNavCon = sap.ui.core.Fragment.byId("ComponentMaterialSelectPopUp", "navCon");						var oDetailPage = sap.ui.core.Fragment.byId("ComponentMaterialSelectPopUp", "bom");						oDetailPage.bindElement("/EquipmentsSet('" + result.results[0].Equipment + "')");						oNavCon.to(oDetailPage);					}										this._oPopover.open();				}.bind(this),				error: function(error) {					this.errorCallBackShowInPopUp(error);				}.bind(this)			});		},		onSelectObject: function(oEvent) {			var equipmentNumber = oEvent.getSource().getBindingContext().getObject().Equipment;			// Davigate to BOM page			var oNavCon = sap.ui.core.Fragment.byId("ComponentMaterialSelectPopUp", "navCon");			var oDetailPage = sap.ui.core.Fragment.byId("ComponentMaterialSelectPopUp", "bom");			oDetailPage.bindElement("/EquipmentsSet('" + equipmentNumber + "')");			oNavCon.to(oDetailPage);		},		onSearchMaterialMaster: function(oEvent) {			var oNavCon = sap.ui.core.Fragment.byId("ComponentMaterialSelectPopUp", "navCon");			var oDetailPage = sap.ui.core.Fragment.byId("ComponentMaterialSelectPopUp", "materialMaster");			oNavCon.to(oDetailPage);		},		onProductSelectedFromSearchResult: function(oEvent) {			var selectedItem = this.getView().getModel().getProperty(oEvent.getSource().getBindingContext().getPath());			var componentDetailsModel = new sap.ui.model.json.JSONModel({				SelectedMaterial: selectedItem,				SelectedMaterialBindingPath: "/MaterialsSet('" + selectedItem.Matnr + "')", //oEvent.getSource().getBindingContext().getPath(),				IsCreate: true			});			componentDetailsModel.setDefaultBindingMode(sap.ui.model.BindingMode.TwoWay);			this.getView().setModel(componentDetailsModel, "ComponentDetailsModel");			var path = this.getView().getBindingContext().getPath() + "/OrderComponent";			// Create new entry with default values			this.newEntry = this.getView().getModel().createEntry(path, {				properties: {					ReqQuantity: "1",					Material: selectedItem.Matnr,					MaterialDescription: selectedItem.Description				}			});			var oNavCon = sap.ui.core.Fragment.byId("ComponentMaterialSelectPopUp", "navCon");			var oDetailPage = sap.ui.core.Fragment.byId("ComponentMaterialSelectPopUp", "detail");			// Bind new item to popover			oDetailPage.setBindingContext(this.newEntry);			oNavCon.to(oDetailPage);		},				searchMaterialPress: function(oEvent) {			var sValue = oEvent.getParameter("query");			var searchString = sValue.toLowerCase();						this.searchMaterial(searchString);		},				searchMaterialLive: function(oEvent) {			var sValue = oEvent.getParameter("newValue");			var searchString = sValue.toLowerCase();						this.searchMaterial(searchString);		},				searchMaterial: function(sValue) {			var aFilters = [];			var searchString = sValue.toLowerCase();			aFilters.push(new sap.ui.model.Filter("Matstring", sap.ui.model.FilterOperator.Contains, searchString));			// update list binding			var list = sap.ui.getCore().byId("ComponentMaterialSelectPopUp--idMaterialMasterTable");			var itemsBinding = list.getBinding("items");			if (itemsBinding) {				itemsBinding.aApplicationFilters = [];				if (aFilters.length > 0) {					var filter = new sap.ui.model.Filter({						filters: aFilters,						and: true					});					itemsBinding.filter(filter);				} else {					itemsBinding.filter(aFilters);				}			}		},		onOK: function(oEvent) {			// If there is nothing to save (no changes) just close the dialog			if (!this.getView().getModel().hasPendingChanges())			{				// Reset navigation				this.onNavBackToTop();				// Close the popup				this._oPopover.close();			}						this._oPopover.setBusy(true);			this.getView().getModel().submitChanges({				success: function(response) {					for (var i = 0; i < response.__batchResponses.length; i++) {						var oResponse = response.__batchResponses[i].response;						if (typeof oResponse !== "undefined" && oResponse.statusCode !== "200") {							this.errorBatchCallBackShowInPopUp(oResponse);							this._oPopover.setBusy(false);							return;						}					}					// Reset view busy					this._oPopover.setBusy(false);					// If we just created a new entity, clear the reference to it					if (this.newEntry) {						this.newEntry = null;					}					// Reset navigation					this.onNavBackToTop();					// Close the popup					this._oPopover.close();				}.bind(this),				error: function(error) {					// Reset view busy					this._oPopover.setBusy(false);					// Show error to user					this.errorCallBackShowInPopUp(error);				}.bind(this)			});		},		onClose: function() {			this._oPopover.close();		},		onDelete: function() {			// Set view busy			this._oPopover.setBusy(true);			// Get reference to page			var oDetailPage = sap.ui.core.Fragment.byId("ComponentMaterialSelectPopUp", "detail");			// Delete from model			this.getView().getModel().remove(oDetailPage.getBindingContext().getPath(), {				success: function() {					this.newEntry = null;					// Reset view busy					this._oPopover.setBusy(false);					// Close the popup					this._oPopover.close();				}.bind(this),				error: function(error) {					// Reset view busy					this._oPopover.setBusy(false);					// Show error to user					this.errorCallBackShowInPopUp(error);				}.bind(this)			});		},		onNavBackMaterialSelectPopUp: function(oEvent) {			this.getView().getModel().deleteCreatedEntry(this.newEntry);			var oNavCon = sap.ui.core.Fragment.byId("ComponentMaterialSelectPopUp", "navCon");			oNavCon.back();		},		onNavBackToTop: function(oEvent) {			var oNavCon = sap.ui.core.Fragment.byId("ComponentMaterialSelectPopUp", "navCon");			oNavCon.backToTop();		},		onNavBackFromBom: function(oEvent) {			//this._oPopover.bindElement(this.getView().getBindingContext().getPath());			var oNavCon = sap.ui.core.Fragment.byId("ComponentMaterialSelectPopUp", "navCon");			oNavCon.backToTop();		},		onGoToMaterialMaster: function() {			var oNavCon = sap.ui.core.Fragment.byId("ComponentMaterialSelectPopUp", "navCon");			var oPage = sap.ui.core.Fragment.byId("ComponentMaterialSelectPopUp", "materialMaster");			oNavCon.to(oPage);		},		onGoToBOM: function() {			var oNavCon = sap.ui.core.Fragment.byId("ComponentMaterialSelectPopUp", "navCon");			var oPage = sap.ui.core.Fragment.byId("ComponentMaterialSelectPopUp", "bom");			oNavCon.to(oPage);		},		orderStatusValid: function(str) {			var oContext = this.getView().getBindingContext();			var model = this.getView().getModel();			return !this.readOnly(oContext, model);		},		formatMaterialImageUrl: function(matnr) {			if (matnr)				return this.getView().getModel().sServiceUrl + this.getView().getModel("ComponentDetailsModel").getProperty("/").SelectedMaterialBindingPath +					"/$value";			else				return "";		},		onIncreaseQuantity: function() {			var quantity = Number(this.getView().getModel().getProperty(this.newEntry.getPath() + "/ReqQuantity"));			quantity++;			this.getView().getModel().setProperty(this.newEntry.getPath() + "/ReqQuantity", quantity.toString());		},		onDecreaseQuantity: function() {			var quantity = Number(this.getView().getModel().getProperty(this.newEntry.getPath() + "/ReqQuantity"));			quantity--;			//make sure that we cannot decrease to negative number			if (quantity < 1) {				return;			}			this.getView().getModel().setProperty(this.newEntry.getPath() + "/ReqQuantity", quantity.toString());		},		onEdit: function(oEvent) {			var selectedItem = this.getView().getModel().getProperty(oEvent.getSource().getBindingContext().getPath());			var selectedItemBindingContext = oEvent.getSource().getBindingContext();			var path = "/MaterialsSet('" + selectedItem.Material + "')";			this.getView().getModel().read(path, {				success: function(result) {					// Fint material					var selectedMaterial = this.getView().getModel().getProperty("/MaterialsSet('" + selectedItem.Material + "')");					// Create and bind view model					var componentDetailsModel = new sap.ui.model.json.JSONModel({						SelectedMaterial: result,						SelectedMaterialBindingPath: path,						IsCreate: false					});					componentDetailsModel.setDefaultBindingMode(sap.ui.model.BindingMode.TwoWay);					this.getView().setModel(componentDetailsModel, "ComponentDetailsModel");					// Set binding to selected item					this.newEntry = selectedItemBindingContext;					// Navigate popover so it starts on the details screen					var oNavCon = sap.ui.core.Fragment.byId("ComponentMaterialSelectPopUp", "navCon");					var oDetailPage = sap.ui.core.Fragment.byId("ComponentMaterialSelectPopUp", "detail");					oDetailPage.setBindingContext(this.newEntry);					oNavCon.to(oDetailPage);					this._oPopover.open();				}.bind(this)			});		},		deleteVisibleFormatter: function(isCreate) {			return !isCreate;		},				formatComponentStatus : function(status)		{			switch (status)			{				case "PR":					return this.getI18nText("WorkOrderDetails-ComponentsBlock-PR");					break;				case "PO":					return this.getI18nText("WorkOrderDetails-ComponentsBlock-PO");					break;				case "GR":					return this.getI18nText("WorkOrderDetails-ComponentsBlock-GR");					break;				case "REJECTED":					return this.getI18nText("WorkOrderDetails-ComponentsBlock-REJECTED");					break;			}						return "";		}	});});